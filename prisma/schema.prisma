// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model tbClientes {
  intCliente  Int      @id @default(autoincrement())
  strNombre   String
  strEmail    String   @unique
  strUsuario  String   @unique
  strContra   String
  strTelefono String?
  bolActivo   Boolean  @default(true)
  datRegistro DateTime @default(now())

  // Relaciones
  tbDirecciones tbDirecciones[]
  tbPedidos     tbPedidos[]
  tbTarjetas    tbTarjetas[] // ‚ú® NUEVO
}

model tbEmpleados {
  intEmpleado        Int         @id @default(autoincrement())
  strNombre          String
  datFechaNacimiento DateTime?
  strEmail           String      @unique
  strTelefono        String?
  strDireccion       String?
  strCiudad          String?
  strEstado          String?
  intCP              Int?
  strPuesto          String
  strDepartamento    String
  dblSalario         Float
  datFechaIngreso    DateTime
  strTipoContrato    String
  strHorario         String
  strUsuario         String      @unique
  strContra          String
  strRol             RolEmpleado
  bolActivo          Boolean     @default(true)
  datCreacion        DateTime    @default(now())
  datActualizacion   DateTime    @updatedAt

  // Relaciones
  tbProductos tbProductos[] @relation("EmpleadoProductos")
}

enum RolEmpleado {
  SUPERADMIN
  ADMIN
  VENDEDOR
}

// ======================================================
//  CATEGOR√çAS Y PRODUCTOS
// ======================================================

model tbCategorias {
  intCategoria     Int      @id @default(autoincrement())
  strNombre        String
  strDescripcion   String?
  strImagen        String?
  strEstatus       String?
  boolDestacado    Boolean?
  datCreacion      DateTime @default(now())
  datActualizacion DateTime @updatedAt

  tbProductos tbProductos[]
}

model tbProductos {
  intProducto         Int     @id @default(autoincrement())
  strNombre           String
  strSKU              String? @unique
  strMarca            String?
  strDescripcion      String?
  strDescripcionLarga String?
  dblPrecio           Float
  intStock            Int     @default(0)
  intStockMinimo      Int?
 strImagen     String? @db.LongText
  jsonImagenes  String? @db.LongText
  bolActivo           Boolean @default(true)
  bolDestacado        Boolean @default(false)
  strEstado           String  @default("activo")

  // Campos de descuento
  bolTieneDescuento      Boolean   @default(false)
  dblPrecioDescuento     Float?
  intPorcentajeDescuento Int?
  datInicioDescuento     DateTime?
  datFinDescuento        DateTime?

  // Campos adicionales
  strPeso        String?
  strDimensiones String?
  strEtiquetas   String?
  jsonVariantes  String? // JSON string para las variantes


  datCreacion      DateTime @default(now())
  datActualizacion DateTime @updatedAt

  intCategoria Int
  tbCategoria  tbCategorias @relation(fields: [intCategoria], references: [intCategoria])

  intCreadoPorId Int?
  tbCreadoPor    tbEmpleados? @relation("EmpleadoProductos", fields: [intCreadoPorId], references: [intEmpleado])

  tbItemsPedido       tbPedidosItems[]
  tbProductoVariantes tbProductoVariantes[] // ‚ú® NUEVO: Relaci√≥n con variantes
}

// ======================================================
//  VARIANTES DE PRODUCTOS
// ======================================================
model tbProductoVariantes {
  intVariante        Int      @id @default(autoincrement())
  intProducto        Int
  strTalla           String // "S", "M", "L", "XL", "XXL", etc.
  strColor           String // "Rojo", "Azul", "Negro", "Blanco", etc.
  intStock           Int      @default(0)
  strSKU             String?  @unique // SKU √∫nico por variante: "PLAYERA-RED-XL"
  dblPrecioAdicional Float?   @default(0) // Precio adicional si esta variante cuesta m√°s
  strImagen          String? // Imagen espec√≠fica de esta variante (ej: foto del color)
  bolActivo          Boolean  @default(true)
  datCreacion        DateTime @default(now())
  datActualizacion   DateTime @updatedAt

  // Relaci√≥n con producto padre
  tbProducto tbProductos @relation(fields: [intProducto], references: [intProducto], onDelete: Cascade)
  
  // Relaci√≥n inversa con items de pedidos
  tbPedidosItems tbPedidosItems[]

  @@unique([intProducto, strTalla, strColor]) // No permitir duplicados de la misma combinaci√≥n
  @@index([intProducto])
  @@index([strTalla])
  @@index([strColor])
}

// ======================================================
//  PEDIDOS Y DETALLES
// ======================================================
model tbPedidos {
  intPedido        Int            @id @default(autoincrement())
  intCliente       Int
  intDireccion     Int? // ‚ú® NUEVO: Relaci√≥n con direcci√≥n de env√≠o
  dblTotal         Float          @default(0)
  dblSubtotal      Float          @default(0) // ‚ú® NUEVO: Subtotal sin env√≠o
  dblCostoEnvio    Float          @default(0) // ‚ú® NUEVO: Costo del env√≠o
  strEstado        EstadoPedido   @default(PENDIENTE) // üöö Estado de ENV√çO
  strEstadoPago    EstadoPagoEnum @default(PENDIENTE) // üí∞ Estado de PAGO (NUEVO)
  strMetodoEnvio   String? // ‚ú® NUEVO: express, estandar, recoger
  strNotasEnvio    String? // ‚ú® NUEVO: Notas adicionales de env√≠o
  datPedido        DateTime       @default(now())
  datActualizacion DateTime       @updatedAt

  tbClientes    tbClientes       @relation(fields: [intCliente], references: [intCliente])
  tbDirecciones tbDirecciones?   @relation(fields: [intDireccion], references: [intDireccion]) // ‚ú® NUEVO
  tbItems       tbPedidosItems[]
  tbPagos       tbPagos?

  @@index([intCliente])
  @@index([strEstado])
}

model tbPedidosItems {
  intPedidoItem     Int         @id @default(autoincrement())
  intPedido         Int
  intProducto       Int
  intVariante       Int? // ‚ú® NUEVO: Referencia a la variante espec√≠fica (opcional)
  intCantidad       Int         @default(1)
  strTalla          String? // ‚ú® Mantener por compatibilidad/redundancia
  strColor          String? // ‚ú® Mantener por compatibilidad/redundancia
  dblSubtotal       Float       @default(0)
  dblPrecioUnitario Float       @default(0)
  
  // Relaciones
  tbPedido            tbPedidos            @relation(fields: [intPedido], references: [intPedido])
  tbProducto          tbProductos          @relation(fields: [intProducto], references: [intProducto])
  tbProductoVariante  tbProductoVariantes? @relation(fields: [intVariante], references: [intVariante]) // ‚ú® NUEVO
  
  @@index([intPedido])
  @@index([intProducto])
  @@index([intVariante])
}

enum EstadoPedido {
  PENDIENTE
  PROCESANDO
  EMPAQUETANDO
  ENVIADO
  ENTREGADO
  CANCELADO
}

enum EstadoPagoEnum {
  PENDIENTE
  PAGADO
  RECHAZADO
  CANCELADO
  REEMBOLSADO
}

// ======================================================
//  PAGOS
// ======================================================

model tbPagos {
  intPago                  Int      @id @default(autoincrement())
  intPedido                Int      @unique
  strMetodoPago            String // tarjeta, paypal, efectivo
  dblMonto                 Float
  strEstado                String   @default("PENDIENTE") // PENDIENTE, APROBADO, RECHAZADO
  strMercadoPagoId         String? // ID del pago en MercadoPago
  strPreferenciaId         String? // ID de la preferencia creada
  intCuotas                Int? // Meses sin intereses
  jsonDetallesPago         String? // JSON con detalles adicionales
  jsonRespuestaMercadoPago String? // Respuesta completa de MP
  datCreacion              DateTime @default(now())
  datActualizacion         DateTime @updatedAt

  tbPedido tbPedidos @relation(fields: [intPedido], references: [intPedido])

  @@index([intPedido])
  @@index([strMercadoPagoId])
  @@index([strPreferenciaId])
}

enum EstadoPago {
  PENDIENTE
  APROBADO
  RECHAZADO
  CANCELADO
  REEMBOLSADO
}

// ======================================================
//  DIRECCIONES
// ======================================================

model tbDirecciones {
  intDireccion      Int      @id @default(autoincrement())
  intCliente        Int
  strCalle          String
  strNumeroExterior String
  strNumeroInterior String?
  strColonia        String
  strCP             String
  strCiudad         String
  strEstado         String
  strPais           String   @default("M√©xico")
  strReferencias    String?
  datCreacion       DateTime @default(now())
  datActualizacion  DateTime @updatedAt

  tbCliente tbClientes  @relation(fields: [intCliente], references: [intCliente])
  tbPedidos tbPedidos[] // ‚ú® NUEVO: Relaci√≥n inversa
}

model tbDescuentosCodigos {
  intDescuentoCodigo     Int      @id @default(autoincrement())
  strCodigo              String   @unique
  intPorcentajeDescuento Int
  datFechaInicio         DateTime
  datFechaFin            DateTime
  bolActivo              Boolean  @default(true)
}

model tbTarjetas {
  intTarjeta          Int      @id @default(autoincrement())
  intCliente          Int
  strNumeroTarjeta    String // Solo √∫ltimos 4 d√≠gitos
  strNombreTarjeta    String
  strTipoTarjeta      String // visa, mastercard, amex
  strFechaExpiracion  String // MM/YY
  strTokenMercadoPago String? // ‚ú® Token de MercadoPago para reutilizar
  datCreacion         DateTime @default(now())
  datActualizacion    DateTime @updatedAt

  tbCliente tbClientes @relation(fields: [intCliente], references: [intCliente])

  @@index([intCliente])
}
